<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>Повідомлення з Microsoft Teams</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
      background-color: #0d1117;
      color: #c9d1d9;
      padding: 2rem;
    }
    h2 {
      font-weight: 600;
      border-bottom: 1px solid #30363d;
      padding-bottom: 0.3em;
      margin-bottom: 1em;
      color: #58a6ff;
    }
    button {
      background-color: #238636;
      color: white;
      border: none;
      padding: 0.5em 1em;
      font-size: 1em;
      cursor: pointer;
      border-radius: 6px;
    }
    button:hover {
      background-color: #2ea043;
    }
    input[type="datetime-local"] {
      padding: 0.4em;
      border-radius: 6px;
      border: 1px solid #30363d;
      background-color: #161b22;
      color: #c9d1d9;
    }
    label {
      font-size: 0.95em;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 1em;
      background-color: #161b22;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(27, 31, 35, 0.1);
    }
    th, td {
      border: 1px solid #30363d;
      padding: 0.6em 1em;
      text-align: left;
      vertical-align: top;
    }
    th {
      background-color: #21262d;
      font-weight: 600;
      color: #58a6ff;
    }
    a {
      color: #58a6ff;
    }
    a.view-btn {
      display: inline-block;
      background-color: #238636;
      color: #fff;
      padding: 0.3em 0.6em;
      border-radius: 6px;
      text-decoration: none;
    }
    a.view-btn:hover {
      background-color: #2ea043;
      text-decoration: none;
    }
    ul {
      margin: 0;
      padding-left: 1.2em;
    }
    li {
      margin-bottom: 0.2em;
    }
    .selected {
      background-color: #343942;
    }
    .wrap-text {
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <h2>Список повідомлень Teams</h2>
  <div>
    <button onclick="loadMessages()">Завантажити повідомлення</button>
    <label style="margin-left: 1em">
      <input type="checkbox" id="filterNoReplies" /> Показати лише без коментарів
    </label>
    <label style="margin-left: 1em">
      Дата до (UTC): <input type="datetime-local" id="cutoffDate" />
    </label>
  </div>
  <hr>
  <div id="output"></div>

  <script>
    let selectedRow = null;
    let graphHeaders, graphTeamId, graphChannelId;

    document.addEventListener("DOMContentLoaded", () => {
      const savedDate = localStorage.getItem("cutoffDate");
      if (savedDate) document.getElementById("cutoffDate").value = savedDate;
    });

      async function refreshRow(row) {
        if (!row) return;
        const id = row.dataset.messageId;
        if (!id || !graphHeaders) return;

        const base = `https://graph.microsoft.com/beta/teams/${graphTeamId}/channels/${graphChannelId}/messages/${id}`;

        const [msgRes, repliesRes] = await Promise.all([
          fetch(base, { headers: graphHeaders }),
          fetch(`${base}/replies`, { headers: graphHeaders })
        ]);

        const message = await msgRes.json();
        const replies = await repliesRes.json();

        if (!msgRes.ok) {
          console.error(message.error?.message || "Помилка при запиті");
          return;
        }
        if (!repliesRes.ok) {
          console.error(replies.error?.message || "Помилка при запиті");
          return;
        }

        row.cells[2].innerHTML = "";
        const repliesContent = createReplyList(replies.value || []);
        if (repliesContent instanceof Node) {
          row.cells[2].appendChild(repliesContent);
        } else {
          row.cells[2].textContent = repliesContent;
        }
        row.cells[3].textContent = extractLastTextBlock(message.attachments?.[0]?.content);
      }
    function createCell(content, className) {
      const cell = document.createElement("td");
      if (content instanceof Node) cell.appendChild(content);
      else cell.textContent = content;
      if (className) cell.classList.add(className);
      return cell;
    }

    function stripHtml(html) {
      const tmp = document.createElement('div');
      tmp.innerHTML = html || '';
      return tmp.textContent || '';
    }

    function createReplyList(replies) {
      if (!replies.length) return "—";
      const ul = document.createElement("ul");
      replies.forEach(r => {
        const li = document.createElement("li");
        const author = r.from?.user?.displayName || "(невідомо)";
        const text = stripHtml(r.body?.content).substring(0, 100) || "(порожній)";
        li.textContent = `${author}: ${text}`;
        ul.appendChild(li);
      });
      return ul;
    }

    function extractLastTextBlock(content) {
      try {
        const json = JSON.parse(content || "{}");
        const blocks = json.body?.filter?.(b => b.type === "TextBlock");
        return blocks?.[blocks.length - 1]?.text || "(немає опису)";
      } catch {
        return content || "(невірний формат)";
      }
    }

    function formatDate(iso) {
      const d = new Date(iso);
      const pad = n => String(n).padStart(2, "0");
      return `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function getTeamsDeepLink(webUrl) {
      if (!webUrl) return "";
      return webUrl.replace(/^https:/, "msteams:");
    }

    function getCommitUrl(content) {
      try {
        const json = JSON.parse(content || "{}");
        const blocks = json.body?.filter?.(b => b.type === "ActionSet");
        return blocks[0].actions[0].url || "";
      } catch {
        return "";
      }
    }

    async function openInTeams(e, webUrl, commitUrl, row) {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      if (selectedRow && selectedRow !== row) {
        refreshRow(selectedRow);
        selectedRow.classList.remove("selected");
      }
      if (row) {
        row.classList.add("selected");
        selectedRow = row;
      }
console.log(commitUrl);
      if (commitUrl) {
        console.log(commitUrl);
        window.open(commitUrl, "_blank");
      }
      const deepLink = getTeamsDeepLink(webUrl);
      if (!deepLink) return;
      window.location.href = deepLink;
    }

    async function loadMessages() {
      const outputDiv = document.getElementById("output");
      outputDiv.innerHTML = "Завантаження...";

      try {
        const config = await (await fetch("config.json")).json();
        const { token, teamId, channelId } = config;

        graphHeaders = {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        };
        graphTeamId = teamId;
        graphChannelId = channelId;

        const filterNoReplies = document.getElementById("filterNoReplies").checked;
        const cutoffRaw = document.getElementById("cutoffDate").value;
        const cutoffDate = cutoffRaw ? new Date(cutoffRaw) : null;
        if (cutoffRaw) localStorage.setItem("cutoffDate", cutoffRaw);

        let url = `https://graph.microsoft.com/beta/teams/${teamId}/channels/${channelId}/messages?$top=10&$expand=replies`;
        const table = document.createElement("table");
        table.innerHTML = "<tr><th>Дата</th><th>Посилання</th><th>Коментарі</th><th>Опис</th></tr>";

        let stop = false;
        while (url && !stop) {
          const res = await fetch(url, { headers: graphHeaders });
          const data = await res.json();

          if (!res.ok) throw new Error(data.error?.message || "Помилка при запиті");

          for (const msg of data.value) {
            const msgDate = new Date(msg.createdDateTime);
            if (cutoffDate && msgDate < cutoffDate) {
              stop = true;
              break;
            }

            if (!msg.replyToId && msg.webUrl) {
              const replies = msg.replies || [];

              if (!filterNoReplies || replies.length === 0) {
                const row = document.createElement("tr");
                row.dataset.messageId = msg.id;
                row.appendChild(createCell(formatDate(msg.createdDateTime)));

                const a = document.createElement("a");
                const commitLink = getCommitUrl(msg.attachments?.[0]?.content);
                a.href = getTeamsDeepLink(msg.webUrl);
                a.textContent = "Відкрити в Teams";
                a.className = "view-btn";
                a.addEventListener("click", e => openInTeams(e, msg.webUrl, commitLink, row));
                row.appendChild(createCell(a));

                row.addEventListener("click", async () => {
                  if (selectedRow && selectedRow !== row) {
                    await refreshRow(selectedRow);
                    selectedRow.classList.remove("selected");
                  }
                  row.classList.add("selected");
                  selectedRow = row;
                  await refreshRow(row);
                });

                row.appendChild(createCell(createReplyList(replies)));
                row.appendChild(createCell(extractLastTextBlock(msg.attachments?.[0]?.content), "wrap-text"));
                table.appendChild(row);
              }
            }
          }

          url = data["@odata.nextLink"] || null;
        }

        outputDiv.innerHTML = "";
        outputDiv.appendChild(table);
      } catch (error) {
        outputDiv.innerHTML = `<p style='color:red;'>⚠️ ${error.message}</p>`;
      }
    }
  </script>
</body>
</html>
